name: Build Service
on: [push] # 触发事件

jobs:
  build:
    runs-on: ubuntu-24.04
    env:
      CCACHE_DIR: /home/runner/work/ccache  # ccache 缓存目录
    steps:
      # - name: Install GCC 13+ (C++23 support)
      #   run: |
      #     sudo add-apt-repository -y ppa:ubuntu-toolchain-r/test
      #     sudo apt-get install -y g++-13 gcc-13
      #     sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-13 90
      #     sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-13 90
      
      - name: 设置 Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'  # 指定明确版本如 '3.12'

      # 配置 ccache 编译缓存
      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ${{ runner.os }}-ccache-xgboost
          max-size: 1024M  # 限制缓存大小

      # 4. 缓存 xgboost 的 build 目录（依赖缓存）
      - name: Cache xgboost build
        uses: actions/cache@v4
        id: cache-xgboost
        with:
          path: |
            xgboost/build
            /usr/local/include/xgboost
            /usr/local/lib/libxgboost.*
          key: ${{ runner.os }}-xgboost-${{ hashFiles('**/CMakeLists.txt', '**/dmlc-core/CMakeLists.txt') }}
          restore-keys: |
            ${{ runner.os }}-xgboost-

      - name: Install dependencies
        if: steps.cache-xgboost.outputs.cache-hit != 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y libboost-all-dev libmlpack-dev libarmadillo-dev libpapi-dev libssl-dev 7zip
          python -m pip install --upgrade pip
          python -m pip install --upgrade setuptools
          pip install cython
          cython --version

      # 仅当缓存未命中时编译 xgboost
      - name: Build xgboost (if cache miss)
        if: steps.cache-xgboost.outputs.cache-hit != 'true'
        run: |
          git clone --recursive https://github.com/dmlc/xgboost
          cd xgboost
          mkdir build && cd build
          cmake -DCMAKE_CXX_COMPILER_LAUNCHER=ccache -DCMAKE_CXX_STANDARD=23 -DCMAKE_BUILD_TYPE=Release ..
          make -j$(nproc)
          sudo make install

      - name: Cache ONNX-runtime build
        uses: actions/cache@v4
        id: cache-onnxruntime
        with:
          path: |
            onnxruntime/build
            /usr/local/include/onnxruntime
            /usr/local/lib/libonnxruntime*
          key: ${{ runner.os }}-onnxruntime-${{ hashFiles('**/build.sh') }}
          restore-keys: |
            ${{ runner.os }}-onnxruntime-

      - name: build ONNX-runtime (if cache miss)
        if: steps.cache-onnxruntime.outputs.cache-hit != 'true'
        run: |
          git clone --recursive https://github.com/microsoft/onnxruntime
          cd onnxruntime
          git checkout v1.22.2
          export ORT_BUILD_WITH_CACHE=1
          ./build.sh --config Release --build_shared_lib --compile_no_warning_as_error --parallel --skip_tests --cmake_extra_defines CMAKE_INSTALL_PREFIX=/usr/local
          cd build/Linux/Release && sudo make install

      - name: build third_party
        run: |
          git clone --recursive https://github.com/nanomsg/nng
          cd nng
          git checkout v1.11
          mkdir build && cd build
          cmake -DCMAKE_BUILD_TYPE=Release ..
          make -j$(nproc)
          sudo make install

          cd ..
          git clone --recursive https://github.com/TA-Lib/ta-lib
          cd ta-lib
          mkdir build && cd build
          cmake -DCMAKE_BUILD_TYPE=Release ..
          make -j$(nproc)
          sudo make install

      # 检出代码
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      # 配置CMake并编译
      - name: Configure and build
        run: |
          git clone --recursive https://github.com/fmtlib/fmt service/third_party/fmt
          git clone --recursive https://github.com/hosseinmoein/DataFrame service/third_party/DataFrame
          mkdir service/build && cd service/build
          cmake .. -DCMAKE_BUILD_TYPE=Release 
          cmake --build . --config Release

      # 显示缓存统计（验证加速效果）
      - name: Show ccache stats
        run: ccache -s
      # 上传构建以便下载
      - name: Upload Build
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: QuantService
          compression-level: 5